___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cookiecode",
  "version": 1,
  "securityGroups": [],
  "displayName": "CookieCode",
  "brand": {
    "id": "CookieCode",
    "displayName": "CookieCode",
    "thumbnail": "data:image/png;base64,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IPE+Af6kZgMN6Ki0ANz/AFtUR+3LAB7MEgKozqMr1qW0AOQjy/g+HQUguoX4k8oeJjbWlJsD0Mh9iNqUQUWIEP/Gvezsyd2PBejyEuJfE4V8W3oXyoUC3FVWpIlQ9kVxPr8Hug9mGX+R12ICMhQPx4+sR/p7zJZf0EUeatoVH//oY1I8gH6K7eu3E+AEOAFOgBPgBDgBToAT4AQ4EqB6vMR7ZIWVmqcwgQhesd3wS/b0IrzNr0Sz0Yqqip/gZJcA2g8fmWr8RT/goAOIpPhJlgAw2EwfoqweoZ7CB5BkdD97hDo6wGQfKMAx9BBIA6RjhADIATodDlDIJrcoQKsn+2Atc4x9GjtPYVTjMzSgoo40B5RGs0XPptAPRlYKARgimaqZz3MWgLbn2aIXXqQBRbM9BACQVIKnBcAXCZiZm5jB6hCSK7eaDCGOs0XyOCbbApvX2gLgSYZAJnItMZbJqAG8tBi7l6y1wAVOvIz0UQmSUhtsOZmBCWBSamjQp5liEtobkEdrkesX0OW/curV06Nr/so+GjAZyf1qqaRg0TIEUHUGOAuLzrcTQz06Oq2Jzp8guvA1JBVJDh2wJzGre5118jhMN8t1EQIIOOVqB+DYG6xTzFkaAG7ouqBf3WVzcjzqTeSiJnqQiRcfdJjJnW912kYA6ENWZrJZxgakmz9K8NeW2jIOAL3piEtGJmsC6v0ogPR4OxvjYtjC/9wRCWIS3YoEPLzTyCGQ7+4LSxGEADjaxFmAJe9x8mBR75vlYSVLPtgxoT1cSmBJ2vXhR17cizK/c9x7AnWdhDRTRnVDs/bjbgwd18Ye1HNflgdxb5UBEoZGXXGEKH3QfDMDeecd6B9xwWIEAeodR8haynPtDnBiSGK39bBU03r4ItB456Gy350kNQr1SJf67Vsi7PePackB0cVLly6KeBC6s2VCLib4dNKty+D/yaefff4FHwFyv/wK8zvJK3Fzv2FPLfr6m8tXvv1OxNtPxOD3u23994P4dGGnMT5FV3/48aeff+EFGBFthxTnq4RsvIyS6H8dOENdQ4t+u/z7H1f+HAEwPBalF/5KGidgf6ovSP27l1mCRaKr//z7n3GU/wcCXqCrviDdSgAAACV0RVh0ZGF0ZTpjcmVhdGUAMjAyMC0wMi0xMFQxNjowMDoxMCswMDowMA7OlXUAAAAldEVYdGRhdGU6bW9kaWZ5ADIwMjAtMDItMTBUMTY6MDA6MTArMDA6MDB/ky3JAAAARnRFWHRzb2Z0d2FyZQBJbWFnZU1hZ2ljayA2LjcuOC05IDIwMTQtMDUtMTIgUTE2IGh0dHA6Ly93d3cuaW1hZ2VtYWdpY2sub3Jn3IbtAAAAABh0RVh0VGh1bWI6OkRvY3VtZW50OjpQYWdlcwAxp/+7LwAAABh0RVh0VGh1bWI6OkltYWdlOjpoZWlnaHQAMTkyDwByhQAAABd0RVh0VGh1bWI6OkltYWdlOjpXaWR0aAAxOTLTrCEIAAAAGXRFWHRUaHVtYjo6TWltZXR5cGUAaW1hZ2UvcG5nP7JWTgAAABd0RVh0VGh1bWI6Ok1UaW1lADE1ODEzNTA0MTAedjfkAAAAD3RFWHRUaHVtYjo6U2l6ZQAwQkKUoj7sAAAAVnRFWHRUaHVtYjo6VVJJAGZpbGU6Ly8vbW50bG9nL2Zhdmljb25zLzIwMjAtMDItMTAvOGMyYmYyMjk0YjQ5ODNhZjVjYzY0YzQxYzAxMzAyYmEuaWNvLnBuZ+W+1o4AAAAASUVORK5CYII\u003d"
  },
  "description": "CookieCode enables your website to comply with GDPR and e-privacy rules by blocking tracking and analytical cookies until the visitor has given their consent.",
  "containerContexts": [
    "WEB"
  ],
  "categories": [
    "TAG_MANAGEMENT",
    "PERSONALIZATION"
  ],
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "SELECT",
    "name": "language",
    "displayName": "Language",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": "nl",
        "displayValue": "Dutch"
      },
      {
        "value": "nlinf",
        "displayValue": "Dutch (informal)"
      },
      {
        "value": "en",
        "displayValue": "English"
      },
      {
        "value": "de",
        "displayValue": "German"
      },
      {
        "value": "es",
        "displayValue": "Spanish"
      },
      {
        "value": "pt",
        "displayValue": "Portuguese"
      },
      {
        "value": "pl",
        "displayValue": "Polish"
      },
      {
        "value": "it",
        "displayValue": "Italian"
      },
      {
        "value": "nl-be",
        "displayValue": "Flemish"
      },
      {
        "value": "fr-be",
        "displayValue": "Walloon"
      }
    ],
    "simpleValueType": true,
    "notSetText": "Use page language (recommended)"
  },
  {
    "type": "GROUP",
    "name": "group_consent_mode",
    "displayName": "Consent mode",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "consent_mode_enabled",
        "checkboxText": "Enable Google Consent Mode support",
        "simpleValueType": true,
        "defaultValue": true,
        "alwaysInSummary": true
      },
      {
        "type": "CHECKBOX",
        "name": "ads_data_redaction",
        "checkboxText": "Redact Ad click identifiers",
        "simpleValueType": true,
        "help": "Ad click identifiers sent in network requests by Google Ads and Floodlight tags will be redacted.",
        "enablingConditions": [
          {
            "paramName": "consent_mode_enabled",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "PARAM_TABLE",
        "name": "consent_mode_defaults",
        "displayName": "Override default consent state",
        "paramTableColumns": [
          {
            "param": {
              "type": "SELECT",
              "name": "name",
              "displayName": "Consent type",
              "macrosInSelect": false,
              "selectItems": [
                {
                  "value": "ad_storage",
                  "displayValue": "ad_storage"
                },
                {
                  "value": "analytics_storage",
                  "displayValue": "analytics_storage"
                },
                {
                  "value": "personalization_storage",
                  "displayValue": "personalization_storage"
                },
                {
                  "value": "functionality_storage",
                  "displayValue": "functionality_storage"
                },
                {
                  "value": "security_storage",
                  "displayValue": "security_storage"
                }
              ],
              "simpleValueType": true
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "TEXT",
              "name": "region",
              "displayName": "Region",
              "simpleValueType": true,
              "valueHint": "All regions"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "RADIO",
              "name": "value",
              "displayName": "Default state",
              "radioItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                }
              ],
              "simpleValueType": true
            },
            "isUnique": false
          }
        ],
        "help": "By default  \u003cem\u003ead_storage, analytics_storage\u003c/em\u003e and \u003cem\u003epersonalization_storage\u003c/em\u003e are set to denied in all regions.",
        "enablingConditions": [
          {
            "paramName": "consent_mode_enabled",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "newRowButtonText": "Add override",
        "editRowTitle": "Override default consent state",
        "newRowTitle": "Override default consent state"
      }
    ],
    "groupStyle": "ZIPPY_OPEN_ON_PARAM"
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const setDefaultConsentState = require('setDefaultConsentState');
const updateConsentState = require('updateConsentState');
const gtagSet = require('gtagSet');
const injectScript = require('injectScript');
const log = require('logToConsole');

const trim = function(x) { return x.trim(); }; 

if (data.consent_mode_enabled) {
  const defaultConsent = {
    ad_storage: 'denied',
    analytics_storage: 'denied',
    personalization_storage: 'denied',
    functionality_storage: 'granted',
    security_storage: 'granted',
  };

  const consentByRegion = {};

  (data.consent_mode_defaults || []).forEach(function (x) {
    if (x.region) {
      consentByRegion[x.region] = consentByRegion[x.region] || { region: x.region.split(',').map(trim) };
      consentByRegion[x.region][x.name] = x.value;
    } else {
      defaultConsent[x.name] = x.value;
    }
  });

  defaultConsent.wait_for_update = 500;
  setDefaultConsentState(defaultConsent);

  for (const prop in consentByRegion) {
    setDefaultConsentState(consentByRegion[prop]);
  }
  
  if (data.ads_data_redaction) {
    gtagSet('ads_data_redaction', true);
  }

  gtagSet({
    'cookiecode.config.consent_mode_enabled': true,
  });
}

let url = 'https://cdn.cookiecode.nl/dist/latest.js?cc:mode=manual';
if (data.language) {
  url += '&cc:language=' + data.language;
}

injectScript(url, data.gtmOnSuccess, data.gtmOnFailure);


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "wait_for_update"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "region"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "cookiecode.*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.cookiecode.nl/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

V1.0
Initial version


